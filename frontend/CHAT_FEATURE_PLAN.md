# Chat with Daily Logs - Implementation Plan

## Overview

Build a chat interface where users can have AI-powered conversations about their daily logs. The implementation will be modular (starting with ChatGPT/OpenAI) and use Vercel AI SDK with assistant-ui components.

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    assistant-ui Components                   ││
│  │  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐  ││
│  │  │ Thread  │  │ Composer │  │ Messages │  │ ActionBar    │  ││
│  │  └─────────┘  └──────────┘  └──────────┘  └──────────────┘  ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              @assistant-ui/react-ai-sdk                      ││
│  │                    useChatRuntime()                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                  AssistantChatTransport                      ││
│  │                    POST /api/chat                            ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Backend API                              │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    /api/chat/route                           ││
│  │  1. Authenticate user                                        ││
│  │  2. Fetch user's logs for context                            ││
│  │  3. Build system prompt with logs                            ││
│  │  4. Stream response via AI provider                          ││
│  └─────────────────────────────────────────────────────────────┘│
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                  AI Provider Registry                        ││
│  │  ┌─────────┐  ┌───────────┐  ┌─────────┐                    ││
│  │  │ OpenAI  │  │ Anthropic │  │ Google  │  (modular)         ││
│  │  └─────────┘  └───────────┘  └─────────┘                    ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| Chat UI | assistant-ui (`@assistant-ui/react`) |
| AI SDK Integration | `@assistant-ui/react-ai-sdk` |
| AI Core | Vercel AI SDK (`ai`) |
| Initial Provider | OpenAI (`@ai-sdk/openai`) |
| Streaming | AI SDK `streamText` + `toDataStreamResponse()` |
| State Management | useChatRuntime (assistant-ui) |

---

## File Structure

```
frontend/src/
├── components/
│   └── chat/
│       ├── ChatPage.tsx              # Main page component
│       ├── ChatThread.tsx            # Thread wrapper with runtime
│       ├── LogsContextPanel.tsx      # Side panel showing logs context
│       └── assistant-ui/             # Generated by npx assistant-ui
│           ├── thread.tsx
│           ├── message.tsx
│           ├── composer.tsx
│           └── action-bar.tsx
├── lib/
│   └── ai/
│       ├── providers.ts              # AI provider registry (modular)
│       ├── prompts.ts                # System prompts for logs chat
│       └── types.ts                  # AI-related types
├── hooks/
│   └── useChatWithLogs.ts            # Custom hook combining chat + logs
└── pages/
    └── ChatPage.tsx                  # Route page component

backend/src/                          # (if separate backend exists)
└── routes/
    └── chat/
        └── route.ts                  # Chat API endpoint
```

---

## Implementation Steps

### Phase 1: Setup & Dependencies

#### Step 1.1: Install Dependencies

```bash
# AI SDK core and React integration
npm install ai @ai-sdk/react @ai-sdk/openai

# assistant-ui components
npm install @assistant-ui/react @assistant-ui/react-ai-sdk

# Add assistant-ui shadcn components
npx assistant-ui add thread
```

#### Step 1.2: Environment Variables

Add to `.env`:
```env
VITE_OPENAI_API_KEY=sk-...           # For client-side (if needed)
OPENAI_API_KEY=sk-...                 # For server-side
VITE_CHAT_API_URL=/api/chat           # Chat endpoint
```

---

### Phase 2: Modular AI Provider Architecture

#### Step 2.1: Create Provider Registry

**File: `src/lib/ai/providers.ts`**

```typescript
import { createProviderRegistry, customProvider } from 'ai';
import { openai } from '@ai-sdk/openai';
// Future: import { anthropic } from '@ai-sdk/anthropic';
// Future: import { google } from '@ai-sdk/google';

// Semantic model tiers for easy switching
const openaiProvider = customProvider({
  languageModels: {
    fast: openai('gpt-4o-mini'),
    standard: openai('gpt-4o'),
    powerful: openai('gpt-4-turbo'),
  },
});

// Registry allows switching providers via string ID
export const aiRegistry = createProviderRegistry({
  openai: openaiProvider,
  // Future: anthropic: anthropicProvider,
  // Future: google: googleProvider,
});

// Default model configuration
export const DEFAULT_PROVIDER = 'openai';
export const DEFAULT_TIER = 'standard';

export function getModel(
  provider: string = DEFAULT_PROVIDER,
  tier: string = DEFAULT_TIER
) {
  return aiRegistry.languageModel(`${provider}:${tier}`);
}
```

#### Step 2.2: Create Prompts Configuration

**File: `src/lib/ai/prompts.ts`**

```typescript
import type { DailyLog } from '@/lib/api/types';

export function buildLogsSystemPrompt(
  logs: DailyLog[],
  userName: string
): string {
  const logsContext = logs
    .map(log => `- [${log.date}] Project: ${log.project_id}, Task: ${log.task_description}, Time: ${log.actual_time_spent}`)
    .join('\n');

  return `You are a helpful AI assistant that helps ${userName} analyze and understand their daily work logs.

## User's Recent Logs:
${logsContext || 'No logs available yet.'}

## Your Capabilities:
- Summarize work patterns and productivity
- Answer questions about specific tasks or projects
- Identify trends in time spent across projects
- Suggest improvements or highlight accomplishments
- Help draft daily/weekly reports

## Guidelines:
- Be concise and actionable
- Reference specific log entries when relevant
- Use dates and project names accurately
- Be encouraging about accomplishments
- Suggest areas for improvement constructively`;
}

export const FALLBACK_SYSTEM_PROMPT = `You are a helpful AI assistant for a daily work logging application. Help users understand their work patterns and productivity.`;
```

---

### Phase 3: Backend API Route

#### Step 3.1: Create Chat Endpoint

**File: `backend/src/routes/chat.ts`** (or Next.js API route pattern)

```typescript
import { streamText, convertToCoreMessages } from 'ai';
import { getModel } from '@/lib/ai/providers';
import { buildLogsSystemPrompt } from '@/lib/ai/prompts';
import { getUserLogs } from '@/services/logs'; // Existing service

export async function POST(req: Request) {
  try {
    // 1. Get authenticated user (from session/token)
    const user = await getAuthenticatedUser(req);
    if (!user) {
      return new Response('Unauthorized', { status: 401 });
    }

    // 2. Parse request
    const { messages, provider, tier, dateRange } = await req.json();

    // 3. Fetch user's logs for context
    const logs = await getUserLogs(user.id, dateRange);

    // 4. Build system prompt with logs context
    const systemPrompt = buildLogsSystemPrompt(logs, user.name);

    // 5. Stream AI response
    const result = streamText({
      model: getModel(provider, tier),
      system: systemPrompt,
      messages: convertToCoreMessages(messages),
    });

    return result.toDataStreamResponse();
  } catch (error) {
    console.error('Chat API error:', error);
    return new Response('Internal Server Error', { status: 500 });
  }
}
```

---

### Phase 4: Frontend Components

#### Step 4.1: Install assistant-ui Components

```bash
npx assistant-ui add thread
```

This generates:
- `src/components/assistant-ui/thread.tsx`
- `src/components/assistant-ui/message.tsx`
- `src/components/assistant-ui/composer.tsx`
- `src/components/assistant-ui/action-bar.tsx`

#### Step 4.2: Create Chat Thread Component

**File: `src/components/chat/ChatThread.tsx`**

```typescript
'use client';
import { AssistantRuntimeProvider } from '@assistant-ui/react';
import { useChatRuntime, AssistantChatTransport } from '@assistant-ui/react-ai-sdk';
import { Thread } from '@/components/assistant-ui/thread';
import { useAuth } from '@/hooks/useAuth';

interface ChatThreadProps {
  dateRange?: { start: string; end: string };
}

export function ChatThread({ dateRange }: ChatThreadProps) {
  const { user } = useAuth();

  const runtime = useChatRuntime({
    transport: new AssistantChatTransport({
      api: '/api/chat',
      body: {
        userId: user?.id,
        dateRange,
      },
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'include', // Send cookies for auth
    }),
  });

  return (
    <AssistantRuntimeProvider runtime={runtime}>
      <Thread />
    </AssistantRuntimeProvider>
  );
}
```

#### Step 4.3: Create Main Chat Page

**File: `src/pages/ChatPage.tsx`**

```typescript
import * as React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { DateRangePicker } from '@/components/ui/DateRangePicker';
import { ChatThread } from '@/components/chat/ChatThread';
import { useMyLogs } from '@/lib/query/hooks/useLogs';
import { Button } from '@/components/ui/button';
import { IconMessageCircle, IconCalendar } from '@tabler/icons-react';

export default function ChatPage() {
  const [dateRange, setDateRange] = React.useState<{
    start: string;
    end: string;
  } | undefined>();

  const { data: logs = [] } = useMyLogs(
    undefined,
    dateRange?.start,
    dateRange?.end
  );

  return (
    <div className="container mx-auto py-6">
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-2">
          <IconMessageCircle className="size-6" />
          <h1 className="text-2xl font-bold">Chat with Your Logs</h1>
        </div>
        <div className="flex items-center gap-2">
          <IconCalendar className="size-4 text-muted-foreground" />
          <DateRangePicker
            value={dateRange}
            onChange={setDateRange}
            placeholder="Filter by date range"
          />
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
        {/* Chat Interface */}
        <div className="lg:col-span-3">
          <Card className="h-[calc(100vh-200px)]">
            <CardContent className="p-0 h-full">
              <ChatThread dateRange={dateRange} />
            </CardContent>
          </Card>
        </div>

        {/* Context Panel */}
        <div className="lg:col-span-1">
          <Card>
            <CardHeader>
              <CardTitle className="text-sm">Logs Context</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm text-muted-foreground mb-2">
                {logs.length} logs loaded
              </p>
              <div className="space-y-2 max-h-[400px] overflow-y-auto">
                {logs.slice(0, 10).map((log) => (
                  <div
                    key={log.id}
                    className="text-xs p-2 bg-muted rounded"
                  >
                    <div className="font-medium">{log.date}</div>
                    <div className="truncate">{log.task_description}</div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
```

#### Step 4.4: Add Route to App.tsx

```typescript
// Add to App.tsx routes
import ChatPage from '@/pages/ChatPage';

// In routes:
<Route
  path="/chat"
  element={
    <ProtectedRoute>
      <DashboardLayout>
        <ChatPage />
      </DashboardLayout>
    </ProtectedRoute>
  }
/>
```

#### Step 4.5: Add Navigation Link

**File: `src/components/layout/AppSidebar.tsx`**

```typescript
// Add to navigation items:
{
  title: 'Chat',
  url: '/chat',
  icon: IconMessageCircle,
}
```

---

### Phase 5: Styling & Customization

#### Step 5.1: Customize Thread Component

The generated `thread.tsx` can be customized:

```typescript
// src/components/assistant-ui/thread.tsx
import { ThreadPrimitive } from '@assistant-ui/react';
import { Composer } from './composer';
import { Message } from './message';

export function Thread() {
  return (
    <ThreadPrimitive.Root className="flex flex-col h-full bg-background">
      <ThreadPrimitive.Viewport className="flex-1 overflow-y-auto p-4">
        <ThreadPrimitive.Empty>
          <div className="flex flex-col items-center justify-center h-full text-muted-foreground">
            <IconMessageCircle className="size-12 mb-4" />
            <p>Start a conversation about your work logs</p>
            <p className="text-sm mt-2">Try asking:</p>
            <ul className="text-sm mt-2 space-y-1">
              <li>"Summarize my work this week"</li>
              <li>"Which project took the most time?"</li>
              <li>"What did I accomplish yesterday?"</li>
            </ul>
          </div>
        </ThreadPrimitive.Empty>
        <ThreadPrimitive.Messages
          components={{
            UserMessage: Message,
            AssistantMessage: Message,
          }}
        />
      </ThreadPrimitive.Viewport>
      <div className="border-t p-4">
        <Composer />
      </div>
    </ThreadPrimitive.Root>
  );
}
```

---

## Provider Switching (Future)

To add a new provider (e.g., Anthropic):

1. Install: `npm install @ai-sdk/anthropic`
2. Update `providers.ts`:

```typescript
import { anthropic } from '@ai-sdk/anthropic';

const anthropicProvider = customProvider({
  languageModels: {
    fast: anthropic('claude-3-haiku-20240307'),
    standard: anthropic('claude-sonnet-4-20250514'),
    powerful: anthropic('claude-3-opus-20240229'),
  },
});

export const aiRegistry = createProviderRegistry({
  openai: openaiProvider,
  anthropic: anthropicProvider, // Add here
});
```

3. Add UI to switch providers (settings or chat header dropdown)

---

## API Endpoints Summary

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/chat` | POST | Stream chat messages |
| `/api/chat/history` | GET | Fetch conversation history (optional) |
| `/api/chat/history` | DELETE | Clear conversation (optional) |

---

## Security Considerations

1. **Authentication**: All chat endpoints require valid session
2. **Authorization**: Users can only chat about their own logs
3. **Rate Limiting**: Implement rate limits on chat API
4. **Input Validation**: Sanitize user messages before processing
5. **API Key Security**: Keep AI provider keys server-side only

---

## Testing Checklist

- [ ] Chat loads without errors
- [ ] Messages send and stream correctly
- [ ] User's logs context is included
- [ ] Date range filter works
- [ ] Authentication is enforced
- [ ] Error states display properly
- [ ] Mobile responsive layout
- [ ] Provider can be switched (config change)

---

## Estimated Implementation Order

1. **Dependencies & Setup** (~30 min)
   - Install packages
   - Set up environment variables

2. **AI Provider Module** (~1 hour)
   - Create providers.ts
   - Create prompts.ts

3. **Backend API** (~2 hours)
   - Create chat endpoint
   - Integrate with existing auth
   - Connect logs service

4. **Frontend Components** (~3 hours)
   - Install assistant-ui components
   - Create ChatThread
   - Create ChatPage
   - Add routing

5. **Styling & Polish** (~1 hour)
   - Customize thread appearance
   - Add context panel
   - Mobile responsiveness

6. **Testing & Refinement** (~1 hour)
   - End-to-end testing
   - Error handling
   - Performance optimization

---

## Dependencies to Install

```bash
# Core AI packages
npm install ai @ai-sdk/react @ai-sdk/openai

# assistant-ui packages
npm install @assistant-ui/react @assistant-ui/react-ai-sdk

# Add UI components
npx assistant-ui add thread
```
